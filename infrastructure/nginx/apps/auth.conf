# Authentication Service Configuration
# Routes /api/auth/* to auth-service container

upstream auth_backend {
    server mhylle-auth-service:3000;
}

# Rate limiting zones for auth endpoints
limit_req_zone $binary_remote_addr zone=auth_login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=auth_api:10m rate=30r/m;

# Auth service routing
location /api/auth/ {
    # Special handling for login endpoint with strict rate limiting
    location = /api/auth/login {
        limit_req zone=auth_login burst=2 nodelay;
        
        # Strip /api/auth prefix
        rewrite ^/api/auth/(.*)$ /$1 break;
        
        proxy_pass http://auth_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Important: Pass cookies through
        proxy_set_header Cookie $http_cookie;
        proxy_pass_header Set-Cookie;
        
        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
    
    # Health check endpoint (no rate limiting, no auth required)
    location = /api/auth/health {
        rewrite ^/api/auth/(.*)$ /$1 break;
        proxy_pass http://auth_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        access_log off;  # Don't log health checks
    }
    
    # All other auth endpoints
    limit_req zone=auth_api burst=10 nodelay;
    
    # Strip /api/auth prefix before proxying
    rewrite ^/api/auth/(.*)$ /$1 break;
    
    proxy_pass http://auth_backend;
    proxy_http_version 1.1;
    
    # Headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Important: Pass cookies through for SSO
    proxy_set_header Cookie $http_cookie;
    proxy_pass_header Set-Cookie;
    
    # WebSocket support (if needed for real-time features)
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # Buffer settings
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
    
    # Error handling
    proxy_intercept_errors on;
    error_page 502 503 504 /auth-service-error.json;
}

# Error response for auth service unavailable
location = /auth-service-error.json {
    internal;
    default_type application/json;
    return 503 '{
        "success": false,
        "error": {
            "code": "AUTH_SERVICE_UNAVAILABLE",
            "message": "Authentication service is temporarily unavailable. Please try again later."
        }
    }';
}