# Application 2 Configuration - Task Management System
# This file defines routing for the App2 frontend and backend services

# Upstream definitions for App2
upstream app2_frontend {
    server app2-frontend:80;
    keepalive 32;
}

upstream app2_backend {
    server app2-backend:3000;
    keepalive 32;
}

# Frontend application routing for App2
location /app2/ {
    # Proxy to Angular frontend
    proxy_pass http://app2_frontend/app2/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # Rate limiting for web traffic
    limit_req zone=web burst=100 nodelay;
    
    # Security headers for frontend
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Handle Angular routing - fallback to index.html for SPA
    location ~* /app2/.*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://app2_frontend;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
    }
    
    # Fallback for Angular routes
    try_files $uri $uri/ @app2_fallback;
}

# Fallback location for Angular routing
location @app2_fallback {
    proxy_pass http://app2_frontend/app2/index.html;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Backend API routing for App2
location /api/app2/ {
    # Proxy to NestJS backend
    proxy_pass http://app2_backend/api/app2/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # Rate limiting for API traffic
    limit_req zone=api burst=50 nodelay;
    
    # API-specific headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    
    # CORS handling for API
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin 'https://mhylle.com';
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, PATCH, DELETE, OPTIONS';
        add_header Access-Control-Allow-Headers 'Authorization, Content-Type, Accept, X-Requested-With';
        add_header Access-Control-Allow-Credentials 'true';
        add_header Access-Control-Max-Age 86400;
        return 204;
    }
    
    # Set CORS headers for actual requests
    add_header Access-Control-Allow-Origin 'https://mhylle.com' always;
    add_header Access-Control-Allow-Credentials 'true' always;
    
    # Timeout settings for API calls
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# WebSocket support for App2 (if needed for real-time features)
location /api/app2/socket.io/ {
    proxy_pass http://app2_backend/api/app2/socket.io/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # WebSocket specific settings
    proxy_buffering off;
    proxy_cache off;
}

# API Documentation for App2 (Swagger)
location /api/app2/docs {
    proxy_pass http://app2_backend/api/app2/docs;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Rate limiting for docs
    limit_req zone=api burst=20 nodelay;
}

# Health check endpoint for App2
location /api/app2/health {
    proxy_pass http://app2_backend/api/app2/health;
    proxy_set_header Host $host;
    access_log off;
    
    # Quick timeout for health checks
    proxy_connect_timeout 2s;
    proxy_send_timeout 2s;
    proxy_read_timeout 2s;
}

# Simple health check for App2 frontend
location /app2/health {
    proxy_pass http://app2_frontend/health;
    access_log off;
}

# Handle App2 favicon
location = /app2/favicon.ico {
    proxy_pass http://app2_frontend/app2/favicon.ico;
    log_not_found off;
    access_log off;
    expires 30d;
    add_header Cache-Control "public, immutable";
}
